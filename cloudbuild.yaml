steps:
  # Build backend base image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-backend-base'
    waitFor: ['-']  # No dependencies, allowing parallel execution
    args: [
      'build', '-t', 'gcr.io/$PROJECT_ID/job-seeker-api-backend-base', 
      '-f', 'Dockerfile', '.'
    ]

  # Push backend base image to Google Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-backend-base'
    waitFor: ['build-backend-base']  # Dependent on build-backend-base
    args: ['push', 'gcr.io/$PROJECT_ID/job-seeker-api-backend-base']

  # Build backend service
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-backend'
    waitFor: ['push-backend-base']  # Dependent on push-backend-base
    args: [
      'build', '-t', 'gcr.io/$PROJECT_ID/job-seeker-api-backend', 
      '-f', 'Dockerfile.backend', '.', 
      '--build-arg', 'BASE_IMAGE=gcr.io/$PROJECT_ID/job-seeker-api-backend-base'
    ]

  # Build backend pubsub service
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-backend-pubsub'
    waitFor: ['push-backend-base']  # Dependent on push-backend-base
    args: [
      'build', '-t', 'gcr.io/$PROJECT_ID/job-seeker-api-backend-pubsub', 
      '-f', 'Dockerfile.pubsub', '.',
      '--build-arg', 'BASE_IMAGE=gcr.io/$PROJECT_ID/job-seeker-api-backend-base'
    ]

  # Push backend image to Google Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-backend'
    waitFor: ['build-backend']  # Dependent on build-backend
    args: ['push', 'gcr.io/$PROJECT_ID/job-seeker-api-backend']

  # Push backend pubsub image to Google Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-backend-pubsub'
    waitFor: ['build-backend-pubsub']  # Dependent on build-backend-pubsub
    args: ['push', 'gcr.io/$PROJECT_ID/job-seeker-api-backend-pubsub']

  # # Deploy backend to Cloud Run
  # - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  #   id: 'deploy-backend'
  #   waitFor: ['push-backend']
  #   entrypoint: 'gcloud'
  #   args: [
  #     'run', 'deploy', 'job-seeker-api-backend',
  #     '--image', 'gcr.io/$PROJECT_ID/job-seeker-api-backend',
  #     '--port', '8000',
  #     '--region', 'us-central1',
  #     '--platform', 'managed',
  #     '--allow-unauthenticated',
  #     '--min-instances', '1'
  #   ]

  # # Deploy backend pubsub to Cloud Run
  # - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  #   id: 'deploy-backend-pubsub'
  #   waitFor: ['push-backend-pubsub']
  #   entrypoint: 'gcloud'
  #   args: [
  #     'run', 'deploy', 'job-seeker-api-backend-pubsub',
  #     '--image', 'gcr.io/$PROJECT_ID/job-seeker-api-backend-pubsub',
  #     '--port', '8001',
  #     '--region', 'us-central1',
  #     '--platform', 'managed',
  #     '--allow-unauthenticated',
  #     '--min-instances', '1'
  #   ]

options:
  logging: CLOUD_LOGGING_ONLY
  env:
    - "DOCKER_BUILDKIT=1"

# Specify the default Cloud Build service account
# serviceAccount: "$PROJECT_NUMBER@cloudbuild.gserviceaccount.com"

serviceAccount: "projects/$PROJECT_ID/serviceAccounts/test-cloud-build@articulate-case-435923-m4.iam.gserviceaccount.com"

